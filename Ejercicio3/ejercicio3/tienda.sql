CREATE DATABASE BD_EJERCICIO4;

USE BD_EJERCICIO4;

CREATE TABLE TRABAJADOR (
ID_T INT PRIMARY KEY,
NOMBRE CHAR(20) NOT NULL,
TARIFA REAL NOT NULL,
OFICIO CHAR(15) NOT NULL
);

ALTER TABLE TRABAJADOR ADD ID_SUPV INT NULL REFERENCES TRABAJADOR;

-- -------------- --
-- TABLA EDIFICIO --
-- -------------- --
CREATE TABLE EDIFICIO (
ID_E INT NOT NULL PRIMARY KEY,
DIR CHAR(15) NOT NULL,
TIPO CHAR (10) NOT NULL,
NIVEL_CALIDAD INT NOT NULL,
CATEGORIA INT NOT NULL
);

-- ---------------- --
-- TABLA ASIGNACION --
-- ---------------- --
CREATE TABLE ASIGNACION (
ID_T INT NOT NULL REFERENCES TRABAJADOR,
ID_E INT NOT NULL REFERENCES EDIFICIO,
FECHA_INICIO DATETIME NOT NULL,
NUM_DIAS INT,
PRIMARY KEY (ID_T, ID_E, FECHA_INICIO)
);

INSERT INTO TRABAJADOR VALUES (1235,"M. FARADAY",12.5,"ELECTRICISTA",1311);
INSERT INTO TRABAJADOR VALUES (1311,"C. COULOMB",15.5,"ELECTRICISTA",1311);
INSERT INTO TRABAJADOR VALUES (1412,"C. NEMO",13.75,"FONTANERO",1520);
INSERT INTO TRABAJADOR VALUES (1520,"H. RICKOVER",11.75,"FONTANERO",1520);
INSERT INTO TRABAJADOR VALUES (2920,"R. GARRET",10.0,"ALBAÃ‘IL",2920);
INSERT INTO TRABAJADOR VALUES (3001,"J. BARRISTER",8.2,"CARPINTERO",3231);
INSERT INTO TRABAJADOR VALUES (3231,"P. MASON",17.4,"CARPINTERO",3231);

-- -------------- --
-- TABLA EDIFICIO --
-- -------------- --
INSERT INTO EDIFICIO VALUES (111,"1213 ASPEN","OFICINA",4,1);
INSERT INTO EDIFICIO VALUES (210,"1011 BIRCH","OFICINA",3,1);
INSERT INTO EDIFICIO VALUES (312,"123 ELM","OFICINA",2,2);
INSERT INTO EDIFICIO VALUES (435,"456 MAPLE","COMERCIO",1,1);
INSERT INTO EDIFICIO VALUES (460,"1415 BEACH","ALMACEN",3,3);
INSERT INTO EDIFICIO VALUES (515,"789 OAK","RESIDENCIA",3,2);

-- ---------------- --
-- TABLA ASIGNACION --
-- ---------------- --
INSERT INTO ASIGNACION VALUES (1235,312,'2001-10-10',5);
INSERT INTO ASIGNACION VALUES (1235,515,'2001-10-17',22);
INSERT INTO ASIGNACION VALUES (1311,435,'2001-10-08',12);
INSERT INTO ASIGNACION VALUES (1311,460,'2001-10-23',24);
INSERT INTO ASIGNACION VALUES (1412,111,'2001-12-01',4);
INSERT INTO ASIGNACION VALUES (1412,210,'2001-11-15',12);
INSERT INTO ASIGNACION VALUES (1412,312,'2001-10-01',10);
INSERT INTO ASIGNACION VALUES (1412,435,'2001-10-15',15);
INSERT INTO ASIGNACION VALUES (1412,460,'2001-10-08',18);
INSERT INTO ASIGNACION VALUES (1412,515,'2001-11-05',8);
INSERT INTO ASIGNACION VALUES (1520,312,'2001-10-30',17);
INSERT INTO ASIGNACION VALUES (1520,515,'2001-10-09',14);
INSERT INTO ASIGNACION VALUES (2920,210,'2001-11-10',15);
INSERT INTO ASIGNACION VALUES (2920,435,'2001-10-28',10);
INSERT INTO ASIGNACION VALUES (2920,460,'2001-10-05',18);
INSERT INTO ASIGNACION VALUES (3001,111,'2001-10-08',14);
INSERT INTO ASIGNACION VALUES (3001,210,'2001-10-27',14);
INSERT INTO ASIGNACION VALUES (3231,111,'2001-10-10',8);
INSERT INTO ASIGNACION VALUES (3231,312,'2001-10-24',20);






-- a
DROP PROCEDURE IF EXISTS procedureA;
DELIMITER //
CREATE PROCEDURE procedureA(IN min_tarifa DECIMAL(10,2), IN max_tarifa DECIMAL(10,2))
BEGIN
    SELECT trab.nombre, trab.tarifa, trab.oficio 
    FROM TRABAJADOR trab 
    WHERE trab.tarifa BETWEEN min_tarifa AND max_tarifa 
    ORDER BY trab.tarifa;
END //
DELIMITER ;

-- b
DROP PROCEDURE IF EXISTS procedureB;
DELIMITER //
CREATE PROCEDURE procedureB(IN id_edificio INT)
BEGIN
    SELECT DISTINCT trab.oficio 
    FROM TRABAJADOR trab 
    JOIN ASIGNACION asig ON trab.ID_T = asig.ID_T 
    WHERE asig.ID_E = id_edificio;
END //
DELIMITER ;

-- c
DROP PROCEDURE IF EXISTS procedureC;
DELIMITER //
CREATE PROCEDURE procedureC()
BEGIN
    SELECT trab.nombre as trabajador, sup.nombre as supervisor 
    FROM TRABAJADOR trab 
    LEFT JOIN TRABAJADOR sup ON trab.ID_SUPV = sup.ID_T 
    ORDER BY trab.nombre;
END //
DELIMITER ;

-- d
DROP PROCEDURE IF EXISTS procedureD;
DELIMITER //
CREATE PROCEDURE procedureD()
BEGIN
    SELECT DISTINCT trab.nombre, trab.oficio 
    FROM TRABAJADOR trab 
    JOIN ASIGNACION asig ON trab.ID_T = asig.ID_T 
    JOIN EDIFICIO edif ON asig.ID_E = edif.ID_E 
    WHERE edif.TIPO = 'OFICINA' 
    ORDER BY trab.nombre;
END //
DELIMITER ;

-- e
DROP PROCEDURE IF EXISTS procedureE;
DELIMITER //
CREATE PROCEDURE procedureE(IN oficio_param VARCHAR(15), IN id_edificio_param INT)
BEGIN
    SELECT SUM(asig.NUM_DIAS) as total_dias 
    FROM ASIGNACION asig 
    JOIN TRABAJADOR trab ON asig.ID_T = trab.ID_T 
    WHERE trab.OFICIO = oficio_param AND asig.ID_E = id_edificio_param;
END //
DELIMITER ;

-- f
DROP PROCEDURE IF EXISTS procedureF;
DELIMITER //
CREATE PROCEDURE procedureF()
BEGIN
    SELECT COUNT(DISTINCT oficio) as num_oficios FROM TRABAJADOR;
END //
DELIMITER ;

-- g
DROP PROCEDURE IF EXISTS procedureG;
DELIMITER //
CREATE PROCEDURE procedureG()
BEGIN
    SELECT sup.nombre as supervisor, MAX(trab.tarifa) as tarifa_maxima 
    FROM TRABAJADOR trab 
    JOIN TRABAJADOR sup ON trab.ID_SUPV = sup.ID_T 
    GROUP BY sup.ID_T, sup.nombre 
    ORDER BY sup.nombre;
END //
DELIMITER ;

-- h
DROP PROCEDURE IF EXISTS procedureH;
DELIMITER //
CREATE PROCEDURE procedureH()
BEGIN
    SELECT sup.nombre as supervisor, COUNT(trab.ID_T) as num_trabajadores, 
           MAX(trab.tarifa) as tarifa_maxima 
    FROM TRABAJADOR trab 
    JOIN TRABAJADOR sup ON trab.ID_SUPV = sup.ID_T 
    GROUP BY sup.ID_T, sup.nombre 
    HAVING COUNT(trab.ID_T) > 1 
    ORDER BY sup.nombre;
END //
DELIMITER ;

-- i
DROP PROCEDURE IF EXISTS procedureI;
DELIMITER //
CREATE PROCEDURE procedureI()
BEGIN
    SELECT nombre, tarifa, oficio 
    FROM TRABAJADOR 
    WHERE tarifa < (SELECT AVG(tarifa) FROM TRABAJADOR) 
    ORDER BY tarifa;
END //
DELIMITER ;

-- j
DROP PROCEDURE IF EXISTS procedureJ;
DELIMITER //
CREATE PROCEDURE procedureJ()
BEGIN
    SELECT trab.nombre, trab.tarifa, trab.oficio 
    FROM TRABAJADOR trab 
    WHERE trab.tarifa < (SELECT AVG(comp.tarifa) FROM TRABAJADOR comp WHERE comp.oficio = trab.oficio) 
    ORDER BY trab.oficio, trab.tarifa;
END //
DELIMITER ;

-- k
DROP PROCEDURE IF EXISTS procedureK;
DELIMITER //
CREATE PROCEDURE procedureK()
BEGIN
    SELECT trab.nombre, trab.tarifa, sup.nombre as supervisor 
    FROM TRABAJADOR trab 
    JOIN TRABAJADOR sup ON trab.ID_SUPV = sup.ID_T 
    WHERE trab.tarifa < (SELECT AVG(comp.tarifa) FROM TRABAJADOR comp WHERE comp.ID_SUPV = trab.ID_SUPV) 
    ORDER BY sup.nombre, trab.tarifa;
END //
DELIMITER ;

-- l
DROP PROCEDURE IF EXISTS procedureL;
DELIMITER //
CREATE PROCEDURE procedureL(IN tarifa_minima DECIMAL(10,2))
BEGIN
    SELECT DISTINCT sup.nombre as supervisor, trab.nombre as trabajador, trab.tarifa 
    FROM TRABAJADOR trab 
    JOIN TRABAJADOR sup ON trab.ID_SUPV = sup.ID_T 
    WHERE trab.tarifa > tarifa_minima 
    ORDER BY sup.nombre, trab.tarifa DESC;
END //
DELIMITER ;







